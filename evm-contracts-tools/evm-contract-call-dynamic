#!/usr/bin/env node

//
// SPDX-License-Identifier: AGPL-3.0-or-later
//

const { ethers } = require(
  "ethers");
_ethers = ethers;
const _libcrash = require(
  '../libcrash-js/crash-js');
_app_name_get = _libcrash._app_name_get;
_dirname = _libcrash._dirname;
_file_read = _libcrash._file_read;
_msg_info = _libcrash._msg_info;
_msg_error = _libcrash._msg_error;
const _contract_get = require(
  '../evm-wallet/contract-get');

function _global_variables() {
  method_args = [];
  wallet_seed = "";
  wallet_password = "";
  contract_address = "";
  contract_method = "";
  contract_abi = "";
  target_network = "";
  api_key = "";
  quiet = "";
}

async function _set(
  _wallet_seed,
  _wallet_password,
  _api_key_path,
  _target_network,
  _contract_address,
  _contract_abi,
  _contract_bytecode,
  _contract_method,
  _method_args) {
  _contract = _contract_get(
    _wallet_seed,
    _wallet_password,
    _api_key_path,
    _target_network,
    _contract_address,
    _contract_abi,
    _contract_bytecode_path);
  _method = _contract.getFunction(
    _contract_method);
  _value = await _method.send.apply(
    null,
    _method_args);
  return _value;
}

async function _contract_run(
  _wallet_seed,
  _wallet_password,
  _api_key_path,
  _target_network,
  _contract_address,
  _contract_abi,
  _contract_bytecode_path,
  _contract_method,
  _method_args) {
  if ( wallet_password == "" ) {
    _msg_info(
      "wallet without password");
  }
  if ( wallet_path == "" ) {
    _wallet_path = [
      _dirname(
        _wallet_seed),
      "wallet.dat"].join("/");
    _msg = "selecting '{_wallet_path}'".replace(
      "{_wallet_path}",
      _wallet_path));
    _msg_info(
      _msg);
  }
  _tx = await _set(
    _wallet_seed,
    _wallet_password,
    _api_key,
    _target_network,
    _contract_address,
    _contract_method,
    _contract_abi,
    _method_args);
  if ( _tx.hash != "" ) {
    _msg_info(
      _value);
    _msg_info(
      "transaction sent");
  }
}

function _config_show() {
  _msgs = [];
  _msg.push(
    "      Wallet seed: {wallet_seed}".replace(
      "{wallet_seed}",
      wallet_seed));
  _msgs.push(
    "  Wallet password: {wallet_password}".replace(
      "{wallet_passward}",
      wallet_password));
  _msgs.push(
    "          API Key: {api_key}".replace(
      "{api_key}",
      api_key));
  _msgs.push(
    "   Target network: {target_network}".replace(
      "{target_network}",
      target_network));
  _msgs.push(
    " Contract address: {contract_address}".replace(
      "{contract_address}",
      contract_address));
  _msgs.push(
    "  Contract method: {contract_method}".replace(
      "{contract_method}",
      contract_method));
  _msgs.push(
    "     Contract ABI: {contract_abi}".replace(
      "{contract_abi}",
      contract_abi.length));
  _method_args = method_args.join(
    " ");
  _msgs.push(
    "      Method args: {method_args}".replace(
      "{method_args}",
      _method_args));
  for (_msg in _msgs)  { 
    _msg_info(
      _msg);
  }
}

function _cmdline_parse() {
  quiet = "y";
  process.argv.forEach(
    function (
      _value,
      _index,
      _array) {
      if ( _index == 2 ) {
        quiet = _value;
      }
      if ( _index == 3 ) {
        wallet_seed = _value;
      }
      if ( _index == 4 ) {
        wallet_password = _value;
      }
      if ( _index == 5 ) {
        api_key = _value;
      }
      if ( _index == 6 ) {
        target_network = _value;
      }
      if ( _index == 7 ) {
        contract_address = _value;
      }
      if ( _index == 8 ) {
        contract_abi = _value;
      }
      if ( _index == 9 ) {
        contract_bytecode_path = _value;
      }
      if ( _index == 10 ) {
        contract_method = _value;
      }
      if ( 10 < _index ) {
        method_args.push(
	  _value);
      }
  });
  if ( contract_address == "" ) {
    _msg = [
      "Usage:",
      "  {app_name}".replace(
        "{app_name}",
        app_name),
      "    <quiet>",
      "    <wallet_seed>",
      "    <wallet_password>",
      "    <api_key>"
      "    <target_network>",
      "    <contract_address>",
      "    <contract_method>",
      "    [contract_args]",
    ]
    for (let _line = 0; _line < _msg.length; _line++) {
      _msg_error(
        _msg[_line],
        0);
    }
    process.exit();
  }
}

_global_variables();
app_name = _app_name_get();
_cmdline_parse();
_config_show();
_contract_run(
  wallet_seed,
  wallet_password,
  contract_address,
  contract_method,
  contract_abi,
  target_network,
  api_key,
  method_args);
